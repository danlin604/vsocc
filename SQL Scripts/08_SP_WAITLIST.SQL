DROP PROCEDURE SP_WAITLIST;

DELIMITER //
CREATE PROCEDURE SP_WAITLIST()
BEGIN

	UPDATE WAITLIST
		SET QUEUE = NULL, EXPIRED = 1
	WHERE
		NOTIFICATION_TIME = NULL
		AND (CURDATE() - 7) > NOTIFICATION_TIME;
    
	SELECT @VAR := 1 FROM WAITLIST WHERE QUEUE = 1;

	UPDATE WAITLIST
		SET QUEUE = QUEUE + 1
	WHERE 
		QUEUE IS NOT NULL
    AND @VAR <> 1;
    
	UPDATE WAITLIST 
		SET NOTIFICATION_TIME = CURDATE()
	WHERE 
		QUEUE = 1;
		
END//
DELIMITER ;